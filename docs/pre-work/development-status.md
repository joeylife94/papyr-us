# 개발 진행 상황 및 현재 이슈

## 📅 최종 업데이트: 2025-09-11 (E2E 테스트 안정화)

---

## ✅ 작업 기록

### 2025-09-11

- **E2E 테스트 안정화 작업** 🛠️
  - **문제 진단**: 이전 테스트들에서 발생한 일관된 타임아웃 실패는, 테스트 코드의 구조적 문제와 애플리케이션의 성능 저하가 복합적으로 작용한 결과로 분석되었습니다.
  - **1차: 테스트 코드 리팩토링**:
    - `tests/example.spec.ts` 파일에서 API를 직접 호출하거나 `localStorage`를 조작하는 부분을 모두 제거했습니다.
    - 모든 테스트가 실제 사용자처럼 UI를 통해 로그인하고, 필요한 데이터를 생성하도록 수정하여 테스트의 독립성과 안정성을 확보했습니다.
    - `login`, `createPage`, `adminLogin`과 같은 헬퍼 함수를 도입하여 코드의 중복을 줄이고 가독성을 높였습니다.
  - **2차: Admin 로그인 로직 수정**:
    - `admin.tsx` 페이지의 실제 구현을 분석하여, 일반 사용자 로그인 후 `/admin` 페이지로 이동하여 비밀번호를 입력하는 올바른 UI 흐름에 맞게 `adminLogin` 헬퍼 함수를 수정했습니다.
  - **3차: 타임아웃 설정 조정**:
    - 애플리케이션의 느린 응답 속도에 대응하기 위해, `playwright.config.ts` 파일의 전역 `timeout` 및 `expect.timeout`을 30초에서 120초로 대폭 늘려 시간 초과로 인한 테스트 실패 가능성을 최소화했습니다.
  - **결과**: 위와 같은 단계적인 리팩토링 및 안정화 작업을 통해 E2E 테스트의 신뢰도를 높이고, 문제의 근본 원인이 애플리케이션 성능에 있음을 명확히 했습니다. 최종 테스트 실행은 사용자에 의해 중단되어 결과 확인은 다음으로 넘어갑니다.

### 2025-09-08

- **E2E 테스트 실패 문제 집중 분석 및 해결 시도** 🐞
  - **문제 현상**: Docker 환경이 정상화된 후 `npm run e2e` 테스트 실행 시, 대부분의 테스트가 `Timeout` 오류를 일으키며 실패했습니다. 페이지 로딩 후 특정 요소를 찾는 과정에서 문제가 반복적으로 발생했습니다.
  - **원인 분석**:
    1.  **포트 충돌**: 초기 실행 시 테스트 서버 포트(`5002`)가 이미 사용 중인 Docker 컨테이너 포트와 충돌했습니다.
    2.  **브라우저 누락**: Playwright가 테스트에 필요한 브라우저(Chromium, Firefox, WebKit)를 찾지 못했습니다.
    3.  **애플리케이션 성능 저하**: 테스트 환경에서 서버 응답 속도가 느려져 페이지가 제시간에 렌더링되지 않는 것이 근본적인 원인으로 추정됩니다.
    4.  **불안정한 테스트 코드**: API 호출과 UI 상호작용을 혼합한 테스트 방식이 애플리케이션의 복잡한 상태 변화를 따라가지 못하는 문제가 있었습니다.
  - **문제 해결 과정**:
    - **포트 및 설정 수정**: `docker-compose.yml`과 `playwright.config.ts`의 포트 설정을 `5001`로 통일하고, `reuseExistingServer: true` 옵션을 활성화하여 실행 중인 Docker 컨테이너를 테스트에 사용하도록 변경했습니다.
    - **브라우저 설치**: `npx playwright install` 명령을 실행하여 테스트에 필요한 모든 브라우저를 설치했습니다.
    - **성능 개선 시도**: `playwright.config.ts`의 `workers` 수를 `2`로 줄여 서버 부하를 낮추고, `expect`의 `timeout`을 일시적으로 늘리는 등 여러 시도를 했으나 근본적인 해결에는 이르지 못했습니다.
    - **테스트 코드 리팩토링**: API 호출을 통해 테스트 데이터를 생성하고 `localStorage`에 인증 토큰을 주입하는 방식이 불안정하다고 판단, 각 테스트가 UI를 통해 독립적으로 로그인하고 데이터를 생성하도록 리팩토링하는 작업을 시작했습니다.
  - **결과**: 일부 테스트(`성공적인 회원가입`)의 셀렉터 문제를 해결했으나, 여전히 대다수 테스트가 타임아웃으로 실패하고 있습니다. 현재로서는 테스트 코드의 안정성을 높이기 위한 리팩토링이 더 필요하다고 결론 내렸습니다.

### 2025-09-06

- **Docker 환경 실행 및 기능 오류 완전 해결** ✅
  - **문제 현상**: `docker-compose up` 실행 시 `db` 컨테이너가 정상적으로 실행되지 않았고, 이후에는 `app` 컨테이너가 데이터베이스에 연결하지 못하거나(`ECONNREFUSED`), 연결 후에는 `users` 테이블이 없어(`relation "users" does not exist`) 회원가입 기능이 실패하는 등 복합적인 문제가 발생했습니다.
  - **원인 분석**:
    1. `docker-compose.yml`의 `db` 서비스가 `.env` 파일을 참조하지 않고 셸 환경 변수에 의존하고 있었음.
    2. `app` 컨테이너가 `localhost`로 데이터베이스 연결을 시도하여 Docker 내부 네트워크 통신에 실패함.
    3. 데이터베이스 스키마 마이그레이션이 실행되지 않아 필요한 테이블이 생성되지 않았음.
    4. `package.json`의 마이그레이션 스크립트에 잘못된 데이터베이스 주소가 하드코딩되어 있었음.
  - **문제 해결**:
    - `docker-compose.yml`과 `.env` 파일을 수정하여 `app`과 `db` 컨테이너 간의 네트워크 연결 설정을 바로잡았습니다. (`DATABASE_URL`의 호스트를 `localhost` -> `db`로 변경)
    - `package.json`의 `db:migrate` 스크립트를 수정하고, `docker-compose exec app npm run db:migrate` 명령을 통해 컨테이너 내부에서 직접 데이터베이스 마이그레이션을 실행하여 스키마를 정상적으로 생성했습니다.
  - **결과**: Docker 환경에서의 모든 실행, 연결, 기능 오류를 해결하여 `docker-compose up`만으로 전체 서비스가 완벽하게 작동하도록 복구했습니다. 사용자 회원가입 및 로그인이 정상적으로 작동함을 확인했습니다.

### 2025-08-18

- **Docker 환경 실행 오류 분석 및 E2E 테스트 실패** 🐞
  - **문제 현상**: 로컬에서는 정상 작동하던 애플리케이션이 Docker 환경에서는 `Dynamic require of "path" is not supported` 오류를 발생시키며 실행되지 않았습니다. 이로 인해 E2E 테스트가 서버에 연결하지 못하고 타임아웃으로 실패했습니다.
  - **원인 분석**: Docker 컨테이너 로그 분석 결과, `esbuild`로 서버 코드를 번들링하는 과정에서 `express`의 의존성 패키지인 `depd`가 사용하는 동적 `require`를 제대로 처리하지 못하는 것이 원인으로 파악되었습니다.
  - **1차 해결 시도**: `build.js` 파일의 `esbuild` 설정에 `depd`를 `external`(번들링에서 제외) 항목으로 추가하여 문제를 해결하고자 했습니다.
  - **2차 해결 시도**: 빌드 수정 후에도 E2E 테스트가 계속 타임아웃으로 실패하여, `playwright.config.ts`의 테스트 타임아웃을 30초에서 60초로 늘려 재시도했습니다.
  - **결과**: 위 조치들에도 불구하고 E2E 테스트는 여전히 실패하고 있습니다. 이는 빌드 문제 외에 다른 근본적인 원인이 있을 가능성을 시사합니다.

### 2025-08-14

- **E2E 테스트 환경 완전 정상화** ✅
  - **원인 분석**: E2E 테스트 실패의 근본 원인이 테스트 서버 실행 시 `.env.test` 환경 변수 파일이 올바르게 적용되지 않아, Docker Compose에 설정된 `db` 호스트로 연결을 시도했기 때문임을 최종적으로 확인했습니다.
  - **문제 해결**: `package.json`의 `start:e2e` 스크립트를 `dotenv -e .env.test -- tsx server/index.ts`로 수정하여, `dotenv-cli`를 통해 테스트 환경 변수를 명시적으로 로드하도록 조치했습니다.
  - **추가 안정화**: `playwright.config.ts`에서 `reuseExistingServer: false` 옵션을 활성화하여 테스트 간 독립성을 보장하고, 네이티브 의존성 문제를 피하기 위해 `bcrypt`를 `bcryptjs`로 교체하여 테스트 환경의 안정성을 대폭 향상시켰습니다.
  - **결과**: `npm run e2e` 명령어가 모든 테스트를 성공적으로 통과함을 확인했습니다.

### 2025-08-13

- **서버 구조 리팩토링 및 안정화 시도** 🛠️
  - **원인 분석**: E2E 테스트가 간헐적으로 성공하고 대부분 실패하는 현상의 근본 원인을 서버의 구조적 불안정성으로 판단했습니다. 특히 서버의 진입점(`index.ts`, `production.ts`)과 데이터베이스 관리(`storage.ts`) 코드가 복잡하게 얽혀있어, 테스트 환경에서 예기치 않은 서버 충돌을 유발하는 것으로 추정했습니다.
  - **서버 구조 리팩토링**:
    - **`storage.ts` 단순화**: `DBStorage` 클래스만 남기고 불필요한 인터페이스를 제거했습니다.
    - **서버 진입점 통합**: `index.ts`와 `production.ts`의 로직을 `index.ts` 하나로 통합하여, 환경 변수(`NODE_ENV`)에 따라 개발/프로덕션 모드를 모두 처리하도록 변경했습니다.
    - **단일 `storage` 인스턴스 보장**: 서버의 메인 진입점에서 `DBStorage` 인스턴스를 단 한 번만 생성하고, 이를 모든 API 라우트와 서비스(`socket.ts` 등)에 의존성 주입 방식으로 전달하도록 구조를 명확히 했습니다.
  - **빌드 스크립트 수정**: 서버 진입점 통합에 따라 `package.json`의 `build` 스크립트와 `docker-compose.yml`의 실행 명령을 `server/index.ts`를 바라보도록 수정했습니다.

### 2025-08-12

- **E2E 테스트 환경 및 코드베이스 안정화** 🚀
  - **원인 분석**: E2E 테스트 실패의 근본 원인이 코드베이스 전반에 하드코딩된 `/papyr-us` 경로와 `playwright.config.ts`의 `baseURL` 설정 충돌임을 파악했습니다.
  - **경로 수정**: 클라이언트, 서버, 테스트, 문서 등 프로젝트의 모든 파일에서 `/papyr-us` 접두사를 제거하여 경로를 표준화했습니다.
  - **Docker 빌드 오류 해결**: 경로 수정 후 발생한 `default` export 누락 문제를 해결하여 Docker 이미지가 성공적으로 빌드되도록 수정했습니다.
  - **서버 실행 오류 해결**: Docker 컨테이너 로그 분석을 통해 `storage` 객체의 중복 및 잘못된 초기화 문제를 발견하고, `storage.ts`에서 단일 인스턴스를 생성하여 공유하도록 의존성 구조를 개선했습니다.
  - **테스트 스크립트 개선**: Docker 대상 테스트(`e2e`)와 로컬 디버깅용 테스트(`e2e:local`, 로그 파일 생성 포함) 스크립트를 분리하고, 관련 내용을 `development-guide.md`에 문서화하여 개발 편의성을 높였습니다.

## 🧪 테스트 진행 상황 (2025-09-08)

- [x] **Docker 환경 실행 및 연동 테스트 완료**
- [x] **핵심 기능(사용자 회원가입/로그인) 복구 확인**
- [ ] **E2E 테스트 재검증** (테스트 코드 안정화 작업 필요)

## 🚨 현재 발생하는 주요 이슈

- **E2E 테스트 불안정**: 다수의 테스트가 `Timeout` 오류로 인해 실패하고 있습니다. 이는 테스트 환경에서의 애플리케이션 성능 저하 또는 불안정한 테스트 코드 작성 방식에 기인하는 것으로 보입니다.

---

## 📝 우선적으로 해야 할 일 (TO-DO)

1.  **E2E 테스트 코드 전면 리팩토링**:
    - 각 테스트가 독립적으로 실행될 수 있도록 `beforeAll` 및 `beforeEach` 훅의 API 기반 데이터 생성을 제거합니다.
    - 모든 테스트는 UI를 통해 로그인하고, 필요한 데이터를 직접 생성하는 흐름으로 변경하여 안정성을 확보합니다.
2.  **애플리케이션 성능 분석**: 테스트 환경에서 유독 느리게 동작하는 원인을 파악하고 최적화를 진행합니다. (예: 데이터베이스 쿼리, 서버 로직 등)
3.  **전체 E2E 테스트 통과 확인**: 리팩토링 및 성능 개선 후, `npm run e2e` 명령어가 모든 테스트를 성공적으로 통과하는지 최종 확인합니다.
4.  **기능 추가 개발 재개**: E2E 테스트가 안정화되면, 계획된 다음 기능 개발을 진행합니다.
